From 779ece96d96f26bf0b7abe2d7a68b52266e01e21 Mon Sep 17 00:00:00 2001
From: Martin Pecka <peckama2@fel.cvut.cz>
Date: Thu, 7 Mar 2019 03:52:17 +0100
Subject: [PATCH 1/2] Rebase from 'upstream'

---
 CHANGELOG.rst              |  5 +++++
 nodes/movie_publisher_node | 18 +++++++++++++++---
 package.xml                |  5 +++--
 3 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/CHANGELOG.rst b/CHANGELOG.rst
index 63b6595..14054f7 100644
--- a/CHANGELOG.rst
+++ b/CHANGELOG.rst
@@ -2,6 +2,11 @@
 Changelog for package movie_publisher
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
+1.1.2 (2019-03-07)
+------------------
+* Made imageio and moviepy mandatory dependencies (they will be removed from package.xml in release repo)
+* Contributors: Martin Pecka
+
 1.1.1 (2019-02-07)
 ------------------
 * Fixed permissions.
diff --git a/nodes/movie_publisher_node b/nodes/movie_publisher_node
index 7d88fe3..8fec6a3 100755
--- a/nodes/movie_publisher_node
+++ b/nodes/movie_publisher_node
@@ -5,12 +5,12 @@ import numbers
 import os
 import re
 import time
+import sys
 
 import rospy
 from sensor_msgs.msg import Image
 
 from cv_bridge import CvBridge, CvBridgeError
-import imageio
 
 import cv2
 try:
@@ -206,6 +206,14 @@ class MoviePublisher:
 
         backend = rospy.get_param("~backend", "moviepy")
         if backend == "moviepy":
+            try:
+                import imageio
+            except ImportError:
+                rospy.logerr('Python package imageio was not found on the system.\n'
+                    'You apparently installed movie_publisher via package manager which cannot install imageio on this system.\n'
+                    'Please, call "sudo python2 -m pip install imageio" manually.\n')
+                raise
+
             # if no or old ffmpeg is found, the first import fails; call the download script from imageio and try again
             try:
                 from moviepy.video.io.VideoFileClip import VideoFileClip
@@ -213,9 +221,13 @@ class MoviePublisher:
                 rospy.logwarn("movie_publisher_node: ffmpeg not found, trying to download it from imageio")
                 imageio.plugins.ffmpeg.download()
                 from moviepy.video.io.VideoFileClip import VideoFileClip
-            except ImportError:
+            except ImportError:                
+                # fallback to opencv backend
                 backend = "opencv"
-        # fallback to opencv backend
+                rospy.logwarn('Python package moviepy was not found on the system, thus a fallback using OpenCV will be used.\n'
+                    'You apparently installed movie_publisher via package manager which cannot install moviepy on this system.\n'
+                    'To get moveipy, call "sudo python2 -m pip install moviepy" manually.\n')
+
         if backend == "opencv":
             VideoFileClip = OpenCVMoviepyShim
 
diff --git a/package.xml b/package.xml
index e8bcbb1..e9ad7a9 100644
--- a/package.xml
+++ b/package.xml
@@ -1,7 +1,7 @@
 <?xml version="1.0"?>
 <package format="2">
   <name>movie_publisher</name>
-  <version>1.1.1</version>
+  <version>1.1.2</version>
   <description>Node for using a video file as video topic source.</description>
 
   <maintainer email="peckama2@fel.cvut.cz">Martin Pecka</maintainer>
@@ -16,7 +16,8 @@
   <exec_depend>cv_bridge</exec_depend>
   <exec_depend>ffmpeg</exec_depend>
   <exec_depend>libav</exec_depend>
-  <!--exec_depend>python-moviepy-pip</exec_depend--> <!-- recommended but optional dependency -->
+  <exec_depend>python-imageio</exec_depend>
+  <exec_depend>python-moviepy-pip</exec_depend> <!-- recommended but optional dependency -->
   <exec_depend>python-opencv</exec_depend>
   <exec_depend version_gte="1.0.2">rosbash_params</exec_depend>
   <exec_depend>rospy</exec_depend>
-- 
2.7.4

